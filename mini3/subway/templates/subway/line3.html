{% extends 'base.html' %}
{% load static %}
{% block title %}3호선{% endblock %}

{% block content %}
    {% block style %}
    <style>
        .train-marker {
            background: url('{% static "marker/line3_down_180_default.png" %}') no-repeat center center;
            width: 30px; /* 마커의 크기 */
            height: 30px; /* 마커의 크기 */
            position: absolute;
            display: none; /* 초기에는 숨김 */
        }
        .train-marker.down {
            background: url('{% static "marker/line3_up_0_default.png" %}') no-repeat center center;
        }
    </style>
    {% endblock %}

    <div class="image-container" id="image-container" style="position: relative;">
        <img class="map-image" src="{% static 'subway/lines/line3.png' %}" id="map-image">
    </div>
{% endblock %}

{% block script %}
<script>
    const upTrainLocations = [
        { x: 2975, y: 1605, station: "상행_오금" },
        { x: 2883, y: 1665, station: "상행_경찰병원" },
        { x: 2821, y: 1715, station: "상행_가락시장" },
        { x: 2711, y: 1820, station: "상행_수서" },
        { x: 2576, y: 1747, station: "상행_일원" },
        { x: 2456, y: 1747, station: "상행_대청" },
        { x: 2340, y: 1747, station: "상행_학여울" },
        { x: 2250, y: 1747, station: "상행_대치" },
        { x: 2155, y: 1747, station: "상행_도곡" },
        { x: 2043, y: 1747, station: "상행_매봉" },
        { x: 1942, y: 1747, station: "상행_양재" },
        { x: 1875, y: 1722, station: "상행_남부터미널" },
        { x: 1840, y: 1690, station: "상행_교대" },
        { x: 1840, y: 1600, station: "상행_고속터미널" },
        { x: 1840, y: 1548, station: "상행_잠원" },
        { x: 1840, y: 1503, station: "상행_신사" },
        { x: 1840, y: 1458, station: "상행_압구정" },
        { x: 1840, y: 1365, station: "상행_옥수" },
        { x: 1840, y: 1315, station: "상행_금호" },
        { x: 1805, y: 1252, station: "상행_약수" },
        { x: 1725, y: 1170, station: "상행_동대입구" },
        { x: 1643, y: 1095, station: "상행_충무로" },
        { x: 1545, y: 985, station: "상행_을지로3가" },
        { x: 1545, y: 845, station: "상행_종로3가" },
        { x: 1478, y: 768, station: "상행_안국" },
        { x: 1423, y: 705, station: "상행_경복궁" },
        { x: 1375, y: 660, station: "상행_독립문" },
        { x: 1294, y: 590, station: "상행_무악재" },
        { x: 1224, y: 590, station: "상행_홍제" },
        { x: 1156, y: 590, station: "상행_녹번" },
        { x: 1078, y: 590, station: "상행_불광" },
        { x: 943, y: 590, station: "상행_연신내" },
        { x: 898, y: 590, station: "상행_구파발" },
        { x: 838, y: 590, station: "상행_지축" },
        { x: 787, y: 590, station: "상행_삼송" },
        { x: 731, y: 590, station: "상행_원흥" },
        { x: 679, y: 590, station: "상행_원당" },
        { x: 624, y: 590, station: "상행_화정" },
        { x: 568, y: 590, station: "상행_대곡" },
        { x: 502, y: 590, station: "상행_백석" },
        { x: 427, y: 590, station: "상행_마두" },
        { x: 350, y: 590, station: "상행_정발산" },
        { x: 272, y: 590, station: "상행_주엽" },
        { x: 201, y: 590, station: "상행_대화" }
    ];

    const downTrainLocations = [
        { x: 201, y: 645, station: "하행_대화" },
        { x: 272, y: 645, station: "하행_주엽" },
        { x: 350, y: 645, station: "하행_정발산" },
        { x: 427, y: 645, station: "하행_마두" },
        { x: 502, y: 645, station: "하행_백석" },
        { x: 568, y: 645, station: "하행_대곡" },
        { x: 624, y: 645, station: "하행_화정" },
        { x: 679, y: 645, station: "하행_원당" },
        { x: 731, y: 645, station: "하행_원흥" },
        { x: 787, y: 645, station: "하행_삼송" },
        { x: 838, y: 645, station: "하행_지축" },
        { x: 898, y: 645, station: "하행_구파발" },
        { x: 943, y: 645, station: "하행_연신내" },
        { x: 1078, y: 645, station: "하행_불광" },
        { x: 1156, y: 645, station: "하행_녹번" },
        { x: 1224, y: 645, station: "하행_홍제" },
        { x: 1294, y: 645, station: "하행_무악재" },
        { x: 1355, y: 660, station: "하행_독립문" },
        { x: 1403, y: 705, station: "하행_경복궁" },
        { x: 1443, y: 760, station: "하행_안국" },
        { x: 1510, y: 835, station: "하행_종로3가" },
        { x: 1510, y: 985, station: "하행_을지로3가" },
        { x: 1620, y: 1085, station: "하행_충무로" },
        { x: 1700, y: 1170, station: "하행_동대입구" },
        { x: 1795, y: 1252, station: "하행_약수" },
        { x: 1810, y: 1285, station: "하행_금호" },
        { x: 1810, y: 1350, station: "하행_옥수" },
        { x: 1810, y: 1438, station: "하행_압구정" },
        { x: 1810, y: 1488, station: "하행_신사" },
        { x: 1810, y: 1538, station: "하행_잠원" },
        { x: 1810, y: 1575, station: "하행_고속터미널" },
        { x: 1810, y: 1680, station: "하행_교대" },
        { x: 1850, y: 1722, station: "하행_남부터미널" },
        { x: 1942, y: 1795, station: "하행_양재" },
        { x: 2043, y: 1795, station: "하행_매봉" },
        { x: 2155, y: 1795, station: "하행_도곡" },
        { x: 2250, y: 1795, station: "하행_대치" },
        { x: 2340, y: 1795, station: "하행_학여울" },
        { x: 2456, y: 1795, station: "하행_대청" },
        { x: 2576, y: 1795, station: "하행_일원" },
        { x: 2711, y: 1875, station: "하행_수서" },
        { x: 2824, y: 1778, station: "하행_가락시장" },
        { x: 2892, y: 1718, station: "하행_경찰병원" },
        { x: 2975, y: 1665, station: "하행_오금" }
    ];

    const stationMap = {};
    upTrainLocations.concat(downTrainLocations).forEach(location => {
        stationMap[location.station] = location;
    });

    let upTrainMarkers = [];
    let downTrainMarkers = [];

    function createTrainMarker(id, direction) {
        const trainMarker = document.createElement('div');
        trainMarker.className = `train-marker ${direction}`;
        trainMarker.id = id;
        document.getElementById('image-container').appendChild(trainMarker);
        return trainMarker;
    }

    function updateMarkerPositionWithCoords(marker, x, y, direction) {
        const trainMarker = marker;
        const img = document.getElementById('map-image');
        const imgRect = img.getBoundingClientRect();
        const containerRect = document.querySelector('.image-container').getBoundingClientRect();

        const scaleX = imgRect.width / img.naturalWidth;
        const scaleY = imgRect.height / img.naturalHeight;

        const markerX = (x * scaleX) + imgRect.left - containerRect.left;
        const markerY = (y * scaleY) + imgRect.top - containerRect.top;

        const imageUrlUp = '{% static "marker/line3_up_90_default.png" %}';
        const imageUrlDown = '{% static "marker/line3_down_270_default.png" %}';
        const imageUrlDefaultUp = '{% static "marker/line3_down_180_default.png" %}';
        const imageUrlDefaultDown = '{% static "marker/line3_up_0_default.png" %}';

        trainMarker.style.left = `${markerX}px`;
        trainMarker.style.top = `${markerY}px`;
        trainMarker.style.transform = `translate(-50%, -50%)`;

        if (direction === 'up') {
            trainMarker.style.background = `url('${imageUrlDefaultUp}') no-repeat center center`;
        } else if (direction === 'down') {
            trainMarker.style.background = `url('${imageUrlDefaultDown}') no-repeat center center`;
        }

        trainMarker.style.backgroundSize = 'contain';
        trainMarker.style.display = 'block'; // 위치가 계산된 후에 표시
    }

    function updateTrainPositionWithRealData(data) {
        data.forEach(train => {
            const direction = train.상하행구분 === 0 ? 'up' : 'down';
            const station = direction === 'up' ? `상행_${train.지하철역명}` : `하행_${train.지하철역명}`;
            const location = stationMap[station];

            if (location) {
                if (direction === 'up') {
                    let existingTrain = upTrainMarkers.find(t => t.trainID === train.열차ID);
                    if (!existingTrain) {
                        existingTrain = addTrain('up', upTrainLocations, train.열차ID);
                    }
                    updateMarkerPositionWithCoords(existingTrain.marker, location.x, location.y, direction);
                    existingTrain.currentIndex = upTrainLocations.findIndex(loc => loc.station === station);
                } else {
                    let existingTrain = downTrainMarkers.find(t => t.trainID === train.열차ID);
                    if (!existingTrain) {
                        existingTrain = addTrain('down', downTrainLocations, train.열차ID);
                    }
                    updateMarkerPositionWithCoords(existingTrain.marker, location.x, location.y, direction);
                    existingTrain.currentIndex = downTrainLocations.findIndex(loc => loc.station === station);
                }
            }
        });
    }

    function addTrain(direction, locations, trainID) {
        const trainId = `${direction}-train-${trainID}`;
        const marker = createTrainMarker(trainId, direction);
        const train = {
            marker: marker,
            currentIndex: 0,
            trainID: trainID
        };
        if (direction === 'up') {
            upTrainMarkers.push(train);
        } else {
            downTrainMarkers.push(train);
        }
        return train;
    }

    // WebSocket 연결 설정
    const socket = new WebSocket('ws://' + window.location.host + '/ws/train-location/');

    socket.onopen = function(e) {
        console.log("WebSocket connection opened.");
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        updateTrainPositionWithRealData(data);
    };

    socket.onclose = function(e) {
        console.log("WebSocket connection closed.");
    };

    socket.onerror = function(e) {
        console.error("WebSocket error: ", e);
    };
</script>
{% endblock %}
