{% extends 'base.html' %}
{% load static %}

{% block title %}3호선 노선도{% endblock %}

{% block content %}
<div class="image-container">
    <img class="map-image" src="{% static 'line3/line3.png' %}" alt="3호선 노선도 이미지">
    <div class="train-marker" id="train-marker"></div>
</div>
    {% block styles %}
    <style>
    .train-marker {
        position: absolute;
        width: 50px;
        height: 50px;
        background: url('{% static "marker/line3_down_180_default.png" %}') no-repeat center center;
        background-size: contain;
        z-index: 1000;
    }
    </style>
    {% endblock %}

{% endblock %}

{% block scripts %}
<script>
    const originalCoords = { x: 2975, y: 1605 }; // Original coordinates on the image

    function resizeImage(action) {
        const img = document.querySelector('.map-image');
        let currentWidth = img.style.width ? parseInt(img.style.width) : 120;
        if (action === 'larger') {
            currentWidth = Math.min(currentWidth + 20, 200);
        } else if (action === 'smaller') {
            currentWidth = Math.max(currentWidth - 20, 100);
        }
        img.style.width = currentWidth + '%';
        updateMarkerPosition();
    }

    document.querySelector('.image-container').addEventListener('wheel', function(event) {
        event.preventDefault();
        if (event.deltaY < 0) {
            resizeImage('larger');
        } else {
            resizeImage('smaller');
        }
    });

    let isDragging = false;
    let startX, startY, imgStartX, imgStartY;

    const container = document.querySelector('.image-container');
    const img = document.querySelector('.map-image');

    container.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        imgStartX = img.offsetLeft;
        imgStartY = img.offsetTop;
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging){
            e.preventDefault();
            const dx = (e.clientX - startX);
            const dy = (e.clientY - startY);
            img.style.left = `${imgStartX + dx}px`;
            img.style.top = `${imgStartY + dy}px`;
            updateMarkerPosition();
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    document.addEventListener('mouseleave', () => {
        isDragging = false;
    });

    // Function to update the marker position based on the image position and scale
    function updateMarkerPosition() {
        const trainMarker = document.getElementById('train-marker');
        const imgRect = img.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();

        const scaleX = imgRect.width / img.naturalWidth;
        const scaleY = imgRect.height / img.naturalHeight;

        const markerX = imgRect.left + (originalCoords.x * scaleX) - containerRect.left;
        const markerY = imgRect.top + (originalCoords.y * scaleY) - containerRect.top;

        trainMarker.style.left = `${markerX}px`;
        trainMarker.style.top = `${markerY}px`;
        trainMarker.style.transform = `translate(-50%, -50%) scale(${scaleX})`;
    }

    function updateMarkerPositionWithCoords(x, y, station) {
    const trainMarker = document.getElementById('train-marker');
    const imgRect = img.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    const scaleX = imgRect.width / img.naturalWidth;
    const scaleY = imgRect.height / img.naturalHeight;

    const markerX = imgRect.left + (x * scaleX) - containerRect.left;
    const markerY = imgRect.top + (y * scaleY) - containerRect.top;

    // Image URLs
    const imageUrlUp = '{% static "marker/line3_up_90_default.png" %}';
    // const imageUrlDown = '{% static "marker/line3_down_180_default.png" %}';
    const imageUrlDefault = '{% static "marker/line3_down_180_default.png" %}';

    trainMarker.style.left = `${markerX}px`;
    trainMarker.style.top = `${markerY}px`;
    trainMarker.style.transform = `translate(-50%, -50%) scale(${scaleX})`;

    // Change the marker image based on the station range
    if (isInStationRange(station, "상행_남부터미널", "상행_독립문")) {
        trainMarker.style.background = `url('${imageUrlUp}') no-repeat center center`;
    } else if (isInStationRange(station, "상행_무악재", "상행_대화") || isInStationRange(station, "상행_오금", "상행_양재")) {
        trainMarker.style.background = `url('${imageUrlDefault}') no-repeat center center`;
    }

    trainMarker.style.backgroundSize = 'contain';
    }

    function isInStationRange(station, startStation, endStation) {
        const stationNames = trainLocations.map(location => location.station);
        const startIndex = stationNames.indexOf(startStation);
        const endIndex = stationNames.indexOf(endStation);
        const currentIndex = stationNames.indexOf(station);

        return currentIndex >= startIndex && currentIndex <= endIndex;
    }


    // Dummy train location data (this should come from your server)
    // 상행 오금 -> 대화
    let trainLocations = [
    { x: 2975, y: 1605, station: "상행_오금" },
    { x: 2883, y: 1665, station: "상행_경찰병원" },
    { x: 2821, y: 1715, station: "상행_가락시장" },
    { x: 2711, y: 1820, station: "상행_수서" },
    { x: 2576, y: 1747, station: "상행_일원" },
    { x: 2456, y: 1747, station: "상행_대청" },
    { x: 2340, y: 1747, station: "상행_학여울" },
    { x: 2250, y: 1747, station: "상행_대치" },
    { x: 2155, y: 1747, station: "상행_도곡" },
    { x: 2043, y: 1747, station: "상행_매봉" },
    { x: 1942, y: 1747, station: "상행_양재" },
    { x: 1875, y: 1722, station: "상행_남부터미널" },
    { x: 1840, y: 1690, station: "상행_교대" },
    { x: 1840, y: 1600, station: "상행_고속터미널" },
    { x: 1840, y: 1548, station: "상행_잠원" },
    { x: 1840, y: 1503, station: "상행_신사" },
    { x: 1840, y: 1458, station: "상행_압구정" },
    { x: 1840, y: 1365, station: "상행_옥수" },
    { x: 1840, y: 1315, station: "상행_금호" },
    { x: 1805, y: 1252, station: "상행_약수" },
    { x: 1725, y: 1170, station: "상행_동대입구" },
    { x: 1643, y: 1095, station: "상행_충무로" },
    { x: 1545, y: 985, station: "상행_을지로3가" },
    { x: 1545, y: 845, station: "상행_종로3가" },
    { x: 1478, y: 768, station: "상행_안국" },
    { x: 1423, y: 705, station: "상행_경복궁" },
    { x: 1375, y: 660, station: "상행_독립문" },
    { x: 1294, y: 590, station: "상행_무악재" },
    { x: 1224, y: 590, station: "상행_홍제" },
    { x: 1156, y: 590, station: "상행_녹번" },
    { x: 1078, y: 590, station: "상행_불광" },
    { x: 943, y: 590, station: "상행_연신내" },
    { x: 898, y: 590, station: "상행_구파발" },
    { x: 838, y: 590, station: "상행_지축" },
    { x: 787, y: 590, station: "상행_삼송" },
    { x: 731, y: 590, station: "상행_원흥" },
    { x: 679, y: 590, station: "상행_원당" },
    { x: 624, y: 590, station: "상행_화정" },
    { x: 568, y: 590, station: "상행_대곡" },
    { x: 502, y: 590, station: "상행_백석" },
    { x: 427, y: 590, station: "상행_마두" },
    { x: 350, y: 590, station: "상행_정발산" },
    { x: 272, y: 590, station: "상행_주엽" },
    { x: 201, y: 590, station: "상행_대화" }
    ];


    let currentIndex = 0;

    function updateTrainPosition() {
    const currentLocation = trainLocations[currentIndex];
    updateMarkerPositionWithCoords(currentLocation.x, currentLocation.y, currentLocation.station);
    currentIndex = (currentIndex + 1) % trainLocations.length;
}



    // Update train position every 1 second (1000 milliseconds)
    setInterval(updateTrainPosition, 1000);

    // Initial update
    updateMarkerPosition();
</script>
{% endblock %}