{% extends 'base.html' %}
{% load static %}

{% block title %}3호선 노선도{% endblock %}

{% block content %}
<div class="image-container">
    <img class="map-image" src="{% static 'line3/line3.png' %}" alt="3호선 노선도 이미지">
    <div class="train-marker" id="train-marker"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const originalCoords = { x: 201, y: 590 }; // Original coordinates on the image

    function resizeImage(action) {
        const img = document.querySelector('.map-image');
        let currentWidth = img.style.width ? parseInt(img.style.width) : 120;
        if (action === 'larger') {
            currentWidth = Math.min(currentWidth + 20, 200);
        } else if (action === 'smaller') {
            currentWidth = Math.max(currentWidth - 20, 100);
        }
        img.style.width = currentWidth + '%';
        updateMarkerPosition();
    }

    document.querySelector('.image-container').addEventListener('wheel', function(event) {
        event.preventDefault();
        if (event.deltaY < 0) {
            resizeImage('larger');
        } else {
            resizeImage('smaller');
        }
    });

    let isDragging = false;
    let startX, startY, imgStartX, imgStartY;

    const container = document.querySelector('.image-container');
    const img = document.querySelector('.map-image');

    container.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        imgStartX = img.offsetLeft;
        imgStartY = img.offsetTop;
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging){
            e.preventDefault();
            const dx = (e.clientX - startX);
            const dy = (e.clientY - startY);
            img.style.left = `${imgStartX + dx}px`;
            img.style.top = `${imgStartY + dy}px`;
            updateMarkerPosition();
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    document.addEventListener('mouseleave', () => {
        isDragging = false;
    });

    // Function to update the marker position based on the image position and scale
    function updateMarkerPosition() {
        const trainMarker = document.getElementById('train-marker');
        const imgRect = img.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();

        // Calculate the scale factors
        const scaleX = imgRect.width / img.naturalWidth;
        const scaleY = imgRect.height / img.naturalHeight;

        // Calculate the new position
        const markerX = imgRect.left + (originalCoords.x * scaleX) - containerRect.left;
        const markerY = imgRect.top + (originalCoords.y * scaleY) - containerRect.top;

        // Set the new position and scale of the marker
        trainMarker.style.left = `${markerX}px`;
        trainMarker.style.top = `${markerY}px`;
        trainMarker.style.transform = `translate(-50%, -50%) scale(${scaleX})`;
    }

    function updateMarkerPositionWithCoords(x, y) {
        const trainMarker = document.getElementById('train-marker');
        const imgRect = img.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();

        // Calculate the scale factors
        const scaleX = imgRect.width / img.naturalWidth;
        const scaleY = imgRect.height / img.naturalHeight;

        // Calculate the new position
        const markerX = imgRect.left + (x * scaleX) - containerRect.left;
        const markerY = imgRect.top + (y * scaleY) - containerRect.top;

        // Set the new position and scale of the marker
        trainMarker.style.left = `${markerX}px`;
        trainMarker.style.top = `${markerY}px`;
        trainMarker.style.transform = `translate(-50%, -50%) scale(${scaleX})`;
    }

    // Dummy train location data (this should come from your server)
    let trainLocations = [
        { x: 201, y: 590 },
        { x: 272, y: 590 }
    ];

    let currentIndex = 0;

    function updateTrainPosition() {
        const currentLocation = trainLocations[currentIndex];
        updateMarkerPositionWithCoords(currentLocation.x, currentLocation.y);
        currentIndex = (currentIndex + 1) % trainLocations.length;
    }

    // Update train position every 2 seconds (2000 milliseconds)
    setInterval(updateTrainPosition, 2000);

    // Initial update
    updateMarkerPosition();
</script>
{% endblock %}
